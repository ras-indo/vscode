name: Build VS Code ARM64

on:
  push:
    branches:
      - main
      - arm64-build

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    env:
      VSCODE_PLATFORM: linux
      VSCODE_ARCH: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - name: Verify Node & npm
        run: |
          node -v
          npm -v
          uname -a

      - name: Install system dependencies (including Kerberos dev headers)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            make \
            g++ \
            python3 \
            python3-dev \
            pkg-config \
            libkrb5-dev \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libgtk-3-dev \
            libnss3-dev \
            libasound2-dev \
            fakeroot \
            rpm \
            ca-certificates \
            git \
            curl

      - name: Clean workspace (remove stray node_modules only) and npm cache
        run: |
          rm -rf node_modules || true
          npm cache clean --force || true
          rm -rf node_modules/native-keymap || true

      - name: Install npm dependencies (use ci when lockfile exists)
        run: |
          if [ -f package-lock.json ]; then
            echo "package-lock.json found → running npm ci"
            npm ci --prefer-offline --no-audit --no-fund
          else
            echo "package-lock.json NOT found → running npm install"
            npm install --prefer-offline --no-audit --no-fund
          fi

      - name: Create 16GB swap (helps avoid OOM on hosted runner)
        run: |
          set -eux
          SWAPFILE=/swapfile
          # create swap only if not exists
          if [ ! -f ${SWAPFILE} ]; then
            sudo fallocate -l 16G ${SWAPFILE} || sudo dd if=/dev/zero of=${SWAPFILE} bs=1M count=16384
            sudo chmod 600 ${SWAPFILE}
            sudo mkswap ${SWAPFILE}
          fi
          sudo swapon ${SWAPFILE} || true
          free -h

      - name: Build VS Code (try minified then fallback to non-minified)
        shell: bash
        run: |
          set -o pipefail
          # Increase V8 heap to 12GB (if runner can support via swap)
          NODE_HEAP="--max-old-space-size=12288"
          echo "Attempting minified build (node ${NODE_HEAP})..."
          if node ${NODE_HEAP} ./node_modules/gulp/bin/gulp.js vscode-linux-arm64-min; then
            echo "Minified build succeeded."
          else
            echo "Minified build failed — attempting non-minified build."
            # try a less memory intensive build
            if node ${NODE_HEAP} ./node_modules/gulp/bin/gulp.js vscode-linux-arm64; then
              echo "Non-minified build succeeded."
            else
              echo "Both minified and non-minified builds failed. Dumping diagnostics..."
              free -h || true
              ps aux --sort=-%mem | head -n 20 || true
              ls -la .build || true
              # fail the job
              exit 1
            fi
          fi

      - name: Cleanup swap
        if: always()
        run: |
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
          free -h || true

      - name: Package build output
        run: |
          mkdir -p out
          cp -r .build/linux-arm64 out/vscode-linux-arm64 || true
          if [ -d out/vscode-linux-arm64 ]; then
            tar -czf vscode-linux-arm64.tar.gz -C out vscode-linux-arm64
          else
            echo "ERROR: expected .build/linux-arm64 missing" >&2
            ls -la .build || true
            false
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-linux-arm64
          path: vscode-linux-arm64.tar.gz